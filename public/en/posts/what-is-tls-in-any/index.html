<!DOCTYPE html>
<html lang="en" dir="ltr">
    <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'><meta name='description' content="Traffic classification? What kind of unheard-of censorship strategy is this? How far away is it from us? Is TLS proxy still safe and hidden?">
<title>Traffic classification can detect encrypted proxies? A First Look at &#34;TLS in Any&#34; vulnerability</title>

<link rel='canonical' href='//localhost:1313/en/posts/what-is-tls-in-any/'>

<link rel="stylesheet" href="/scss/style.min.340891fe47c17ec980bc93daa4d2b44b8d082ebb4f25afee6a93529b2ed2ca66.css"><meta property='og:title' content="Traffic classification can detect encrypted proxies? A First Look at \"TLS in Any\" vulnerability">
<meta property='og:description' content="Traffic classification? What kind of unheard-of censorship strategy is this? How far away is it from us? Is TLS proxy still safe and hidden?">
<meta property='og:url' content='//localhost:1313/en/posts/what-is-tls-in-any/'>
<meta property='og:site_name' content='ObjShadow&#39;s Blog'>
<meta property='og:type' content='article'><meta property='article:section' content='Posts' /><meta property='article:tag' content='Anti-censorship' /><meta property='article:tag' content='Traffic classification' /><meta property='article:tag' content='TLS' /><meta property='article:tag' content='Encrypted proxy' /><meta property='article:published_time' content='2024-07-31T16:00:00&#43;08:00'/><meta property='article:modified_time' content='2024-07-31T16:00:00&#43;08:00'/>
<meta name="twitter:title" content="Traffic classification can detect encrypted proxies? A First Look at \"TLS in Any\" vulnerability">
<meta name="twitter:description" content="Traffic classification? What kind of unheard-of censorship strategy is this? How far away is it from us? Is TLS proxy still safe and hidden?">
  


<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/site.webmanifest">

<script>

const MainTitle = "ObjShadow's Blog"
if (document.title != MainTitle) {
    document.title = [document.title,MainTitle].join(" - ")
}
</script>
    </head>
    <body class="
    article-page
    ">
    <script>
        (function() {
            const colorSchemeKey = 'StackColorScheme';
            if(!localStorage.getItem(colorSchemeKey)){
                localStorage.setItem(colorSchemeKey, "auto");
            }
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'StackColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.scheme = 'dark';
        } else {
            document.documentElement.dataset.scheme = 'light';
        }
    })();
</script>
<div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky ">
    <button class="hamburger hamburger--spin" type="button" id="toggle-menu" aria-label="Toggle Menu">
        <span class="hamburger-box">
            <span class="hamburger-inner"></span>
        </span>
    </button>

    <header>
        
            
            <figure class="site-avatar">
                <a href="/en/">
                
                    
                    
                    
                        
                        <img src="/avatar_hude6f86a7b4117462b6b69e18024e8d1b_51140_300x0_resize_q75_box.jpg" width="300"
                            height="300" class="site-logo" loading="lazy" alt="Avatar">
                    
                
                </a>
                
                    <span class="emoji">👀</span>
                
            </figure>
            
        
        
        <div class="site-meta">
            <h1 class="site-name"><a href="//localhost:1313/">ObjShadow&#39;s Blog</a></h1>
            <h2 class="site-description">May a Censorship Researcher.</h2>
        </div>
    </header><ol class="menu-social">
            
                <li>
                    <a 
                        href='mailto:shadowobject@protonmail.com'
                        target="_blank"
                        title="Email"
                        rel="me"
                    >
                        
                        
                            <svg  xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-mail"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M3 7a2 2 0 0 1 2 -2h14a2 2 0 0 1 2 2v10a2 2 0 0 1 -2 2h-14a2 2 0 0 1 -2 -2v-10z" /><path d="M3 7l9 6l9 -6" /></svg>
                        
                    </a>
                </li>
            
                <li>
                    <a 
                        href='https://keys.openpgp.org/vks/v1/by-fingerprint/FDEAA5F05C3B8D3A9A96DC7DE4465C42D44B171A'
                        target="_blank"
                        title="PGP Key"
                        rel="me"
                    >
                        
                        
                            <svg  xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-key"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M16.555 3.843l3.602 3.602a2.877 2.877 0 0 1 0 4.069l-2.643 2.643a2.877 2.877 0 0 1 -4.069 0l-.301 -.301l-6.558 6.558a2 2 0 0 1 -1.239 .578l-.175 .008h-1.172a1 1 0 0 1 -.993 -.883l-.007 -.117v-1.172a2 2 0 0 1 .467 -1.284l.119 -.13l.414 -.414h2v-2h2v-2l2.144 -2.144l-.301 -.301a2.877 2.877 0 0 1 0 -4.069l2.643 -2.643a2.877 2.877 0 0 1 4.069 0z" /><path d="M15 9h.01" /></svg>
                        
                    </a>
                </li>
            
                <li>
                    <a 
                        href='https://signal.me/#eu/1-a3Slz1elCbLBF_RkBBZbhlwoA47hFcTChiP7lq_2yrjuoClBJFF6ZF_ij4ORo_'
                        target="_blank"
                        title="Signal"
                        rel="me"
                    >
                        
                        
                            <svg  xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-message-circle"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M3 20l1.3 -3.9c-2.324 -3.437 -1.426 -7.872 2.1 -10.374c3.526 -2.501 8.59 -2.296 11.845 .48c3.255 2.777 3.695 7.266 1.029 10.501c-2.666 3.235 -7.615 4.215 -11.574 2.293l-4.7 1" /></svg>
                        
                    </a>
                </li>
            
                <li>
                    <a 
                        href='https://t.me/objshadow'
                        target="_blank"
                        title="Telegram"
                        rel="me"
                    >
                        
                        
                            <svg  xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-brand-telegram"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M15 10l-4 4l6 6l4 -16l-18 7l4 2l2 6l3 -4" /></svg>
                        
                    </a>
                </li>
            
                <li>
                    <a 
                        href='https://twitter.com/objectshadow'
                        target="_blank"
                        title="Twitter"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M22 4.01c-1 .49 -1.98 .689 -3 .99c-1.121 -1.265 -2.783 -1.335 -4.38 -.737s-2.643 2.06 -2.62 3.737v1c-3.245 .083 -6.135 -1.395 -8 -4c0 0 -4.182 7.433 4 11c-1.872 1.247 -3.739 2.088 -6 2c3.308 1.803 6.913 2.423 10.034 1.517c3.58 -1.04 6.522 -3.723 7.651 -7.742a13.84 13.84 0 0 0 .497 -3.753c-.002 -.249 1.51 -2.772 1.818 -4.013z" />
</svg>



                        
                    </a>
                </li>
            
        </ol><ol class="menu" id="main-menu">
        
        
        
        <li >
            <a href='/en/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <polyline points="5 12 3 12 12 3 21 12 19 12" />
  <path d="M5 12v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-7" />
  <path d="M9 21v-6a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v6" />
</svg>



                
                <span>Home</span>
            </a>
        </li>
        
        
        <li >
            <a href='/en/page/about/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="7" r="4" />
  <path d="M6 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2" />
</svg>



                
                <span>About</span>
            </a>
        </li>
        
        
        <li >
            <a href='/en/page/archives/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <rect x="3" y="4" width="18" height="4" rx="2" />
  <path d="M5 8v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-10" />
  <line x1="10" y1="12" x2="14" y2="12" />
</svg>



                
                <span>Archives</span>
            </a>
        </li>
        
        
        <li >
            <a href='/en/page/search/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="10" cy="10" r="7" />
  <line x1="21" y1="21" x2="15" y2="15" />
</svg>



                
                <span>Search</span>
            </a>
        </li>
        
        
        <li >
            <a href='/en/page/links/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M10 14a3.5 3.5 0 0 0 5 0l4 -4a3.5 3.5 0 0 0 -5 -5l-.5 .5" />
  <path d="M14 10a3.5 3.5 0 0 0 -5 0l-4 4a3.5 3.5 0 0 0 5 5l.5 -.5" />
</svg>



                
                <span>Links</span>
            </a>
        </li>
        
        <li class="menu-bottom-section">
            <ol class="menu">
                    
                        <li id="i18n-switch">  
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-language" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M4 5h7" />
  <path d="M9 3v2c0 4.418 -2.239 8 -5 8" />
  <path d="M5 9c-.003 2.144 2.952 3.908 6.7 4" />
  <path d="M12 20l4 -9l4 9" />
  <path d="M19.1 18h-6.2" />
</svg>



                            <select name="language" title="language" onchange="window.location.href = this.selectedOptions[0].value">
                                
                                    <option value="//localhost:1313/" >简体中文</option>
                                
                                    <option value="//localhost:1313/en/" selected>English</option>
                                
                            </select>
                        </li>
                    
                

                
                    <li id="dark-mode-toggle">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="8" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="16" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <span>Dark Mode</span>
                    </li>
                
            </ol>
        </li>
    </ol>
</aside>

    <aside class="sidebar right-sidebar sticky">
        
            
                
    <section class="widget archives">
        <div class="widget-icon">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <line x1="5" y1="9" x2="19" y2="9" />
  <line x1="5" y1="15" x2="19" y2="15" />
  <line x1="11" y1="4" x2="7" y2="20" />
  <line x1="17" y1="4" x2="13" y2="20" />
</svg>



        </div>
        <h2 class="widget-title section-title">Table of contents</h2>
        
        <div class="widget--toc">
            <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#ℹ-introduction">ℹ️ Introduction</a></li>
        <li><a href="#-what-causes-the-tls-in-any-vulnerability">🔍 What causes the &ldquo;TLS in Any&rdquo; vulnerability?</a></li>
        <li><a href="#why-does-the-tls-in-any-issue-need-to-be-taken-seriously">🤔Why does the TLS in Any issue need to be taken seriously?</a></li>
        <li><a href="#inspiration-from-the-censorship-strategy-based-on-traffic-classification">💡Inspiration from the censorship strategy based on traffic classification</a></li>
        <li><a href="#conceived-avoidance-strategies-for-the-tls-in-any-problem">🧰Conceived avoidance strategies for the TLS in Any problem</a></li>
        <li><a href="#several-challenges-for-censors-to-deploy-traffic-classification-based-censorship-strategies-at-scale">🧱Several challenges for censors to deploy traffic classification-based censorship strategies at scale</a></li>
      </ul>
    </li>
  </ul>
</nav>
        </div>
    </section>

            
        
    </aside>


            <main class="main full-width">
    <article class="main-article">
    <header class="article-header">

    <div class="article-details">
    
    <header class="article-category">
        
            <a href="/en/categories/anti-censorship/" >
                Anti-Censorship
            </a>
        
            <a href="/en/categories/tls/" >
                TLS
            </a>
        
    </header>
    

    <div class="article-title-wrapper">
        <h2 class="article-title">
            <a href="/en/posts/what-is-tls-in-any/">Traffic classification can detect encrypted proxies? A First Look at &#34;TLS in Any&#34; vulnerability</a>
        </h2>
    
        
        <h3 class="article-subtitle">
            Traffic classification? What kind of unheard-of censorship strategy is this? How far away is it from us? Is TLS proxy still safe and hidden?
        </h3>
        
    </div>

    
    
    
    
    
    <footer class="article-time">
        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M11.795 21h-6.795a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v4" />
  <circle cx="18" cy="18" r="4" />
  <path d="M15 3v4" />
  <path d="M7 3v4" />
  <path d="M3 11h16" />
  <path d="M18 16.496v1.504l1 1" />
</svg>
                <time class="article-time--published">2024-07-31 PM</time>
            </div>
        

        
            <div>
                <svg  xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-letter-case"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M17.5 15.5m-3.5 0a3.5 3.5 0 1 0 7 0a3.5 3.5 0 1 0 -7 0" /><path d="M3 19v-10.5a3.5 3.5 0 0 1 7 0v10.5" /><path d="M3 13h7" /><path d="M21 12v7" /></svg>
                <time class="article-time--reading">
                    2796 words
                </time>
            </div>
        

        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <polyline points="12 7 12 12 15 15" />
</svg>



                <time class="article-time--reading">
                    14 minute read
                </time>
            </div>
        
    </footer>
    

    
        <footer class="article-translations">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-language" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M4 5h7" />
  <path d="M9 3v2c0 4.418 -2.239 8 -5 8" />
  <path d="M5 9c-.003 2.144 2.952 3.908 6.7 4" />
  <path d="M12 20l4 -9l4 9" />
  <path d="M19.1 18h-6.2" />
</svg>



            <div>
                
                    <a href="//localhost:1313/posts/what-is-tls-in-any/" class="link">简体中文</a>
                
            </div>
        </footer>
    
</div>

</header>

    <section class="article-content">
    
    
    <p>(All the content below is translated from Chinese by Google Translate ↓)
(Please feel free to make your own comments at the translation below.)</p>
<p>📢First, answer the questions raised above:</p>
<ol>
<li>
<p>Traffic classification refers to <strong>passively</strong> recording certain visible indicators of traffic without <strong>destroying the original encryption and integrity of the data</strong>, to determine certain characteristics of the source or destination of the traffic, such as what type of client is, what type of server is, and what purpose the traffic is for.</p>
</li>
<li>
<p>This censorship strategy is indeed unheard of; before the academic field proposed a censorship strategy based on traffic classification, people and censors focused on matching <strong>specific location data</strong> in the traffic with certain data sets, or observing <strong>specific reactions</strong> of the client/server to response carefully constructed data packets sent by the censor, in order to achieve the purpose of censorship (while developers and researchers of anti-censorship tools explore anti-censorship strategies in conjunction with network measurements, etc.).</p>
</li>
<li>
<p>TLS proxies are still <strong>secure</strong>, but as of the publication of this article, the concealment of all open source TLS proxies in use is <strong>questionable</strong> about in the experimental data of the <a class="link" href="https://www.usenix.org/conference/usenixsecurity24/presentation/xue-fingerprinting"  target="_blank" rel="noopener"
    >paper</a> mentioned below, including some proxy implementations that <strong>use multiplexing</strong>.</p>
</li>
</ol>
<p>Note: Here we need to clarify the difference between &ldquo;security&rdquo; and &ldquo;concealment&rdquo;. In the context of anti-censorship, security generally refers to the <strong>invisibility</strong> and <strong>integrity</strong> of data when it is transmitted in <strong>untrusted channels</strong> under current computing power conditions; while confidentiality generally refers to the <strong>negative similarity</strong> of data with <strong>certain specific data</strong> when it is transmitted in untrusted channels, as well as the <strong>negative similarity</strong> of the client and server with <strong>certain specific implementations</strong>.</p>
<p>Let&rsquo;s get into the main text.</p>
<p>The reason why I wrote this article is that I saw a paper titled &ldquo;<a class="link" href="https://www.usenix.org/conference/usenixsecurity24/presentation/xue-fingerprinting"  target="_blank" rel="noopener"
    >Fingerprinting Obfuscated Proxy Traffic with Encapsulated TLS Handshakes</a>&rdquo; on <a class="link" href="https://censoredplanet.org/"  target="_blank" rel="noopener"
    >Censored Planet</a> at the beginning of this year, which also caused some discussion in the circumvention field, so I decided to study it carefully, hoping to explain some core concepts and the editor&rsquo;s own ideas to readers here. This blog was born for this article.</p>
<p>(Note: The &ldquo;circumvention tools&rdquo; referred to in this article refer to systems or protocols used to circumvent network censorship)</p>
<h3 id="ℹ-introduction">ℹ️ Introduction
</h3><p>The currently widely recognized strategies for circumventing censorship can be abstractly summarized into two types:</p>
<ol>
<li>Steganography: Make the traffic look like allowed traffic.</li>
<li>Polymorphism: Make the traffic look like no other traffic.</li>
</ol>
<p>&ldquo;Polymorphism&rdquo; is the strategy adopted by a number of protocols such as shadowsocks. It means doing some encrypt, pad, reorder, to turn the network traffic into a random byte stream, in order to make sure that there is no plaintext in the traffic visible to the censor, and the censor cannot find a fixed regular expression to match, so as to avoid being identified and blocked.
(Note: In fact, the proportion of completely random traffic on the Internet is extremely low, so <strong>randomness itself is just a feature</strong>, which directly led to the use of <strong>entropy-based rules</strong> (here <strong>entropy</strong> means the randomness of data) by GFW <em>(the national level censor in mainland China)</em> to roughly detect and block circumvention tools such as shadowsocks, see the paper <a class="link" href="https://gfw.report/publications/usenixsecurity23/data/paper/paper.pdf"  target="_blank" rel="noopener"
    >How the Great Firewall of China Detects and Blocks Fully Encrypted Traffic</a>. Of course, later developers of anti-censorship tools adopted designs such as padding to change entropy to circumvent this censorship strategy)</p>
<p>The <strong>necessary prerequisite</strong> for &ldquo;steganography&rdquo; is that there must be at least one type of allowed traffic, such as WeChat calls and TLS. The following paragraphs refer to this allowed traffic as &ldquo;the protocol&rdquo;.</p>
<p>&ldquo;Steganography&rdquo; can be abstractly divided into two types:</p>
<ol>
<li>
<p>Imitation: <strong>pretend</strong> to be a certain implementation of the protocol for transmission.</p>
</li>
<li>
<p>Tunneling: <strong>direct</strong> use a certain implementation of the protocol for transmission.</p>
</li>
</ol>
<p>These two steganographic methods may not seem to be very different, but in fact they are very different. For example, &ldquo;steganography&rdquo; is like replacing the Mac icon pack on a Windows computer and using a simulated Mac desktop, but no matter how the underlying layer is Windows, it will never run Finder <em>(the official file manager of MacOS)</em>. &ldquo;Tunneling&rdquo; is like using a Mac directly, without any &ldquo;flaws&rdquo;.</p>
<p>&ldquo;Imitation&rdquo; is widely believed to be impossible to be used to circumvent censorship, because when claiming to be a certain implementation of the protocol, the various different reactions, implementation quirks and even bugs of the implementation must be implemented, otherwise the censor can distinguish between normal traffic and circumvention traffic by confirming whether the implementation has these details that should be there. For the developers of circumvention tools, common implementations are often very complex and it is impossible to achieve perfect imitation. If the circumvention tool imitates a simple implementation, often the simple implementation itself is not common enough, and they will be blocked by the censors. The paper <a class="link" href="https://ieeexplore.ieee.org/document/6547102"  target="_blank" rel="noopener"
    >The Parrot Is Dead: Observing Unobservable Network Communications</a> analyzes this vulnerability more carefully and in detail.</p>
<p>Therefore, &ldquo;Tunneling&rdquo; has become a widely used steganographic method in circumvent tools. It calls the interface provided by a common implementation, passes the data to this interface, and the circumvent traffic is encapsulated and transmitted by the implementation. All the widely used TLS-based evasion tools now belong to this type of &ldquo;steganography&rdquo;.</p>
<h3 id="-what-causes-the-tls-in-any-vulnerability">🔍 What causes the &ldquo;TLS in Any&rdquo; vulnerability?
</h3><p>The reason why traffic is called traffic, is that traffic is composed of a series of data packets within a connection, and these data packets have their own size and sequence. At the beginning of each type of traffic, there are usually several data packets that follow specific specifications to meet specific needs. These data packets are called <strong>&ldquo;handshake packets&rdquo;</strong>. WeChat calls have their own handshake packets, HTTP for web browsing has its own handshake packets, and TLS, in order to achieve data security and integrity, needs to exchange encryption and authentication data (keys and certificates, etc.) in a secure way at the beginning of the connection, so it also has its own handshake packets.</p>
<p>It is these TLS handshake packets that cause the &ldquo;TLS in Any&rdquo; vulnerability. Remember the definition of &ldquo;handshake packets&rdquo; above? They are &ldquo;some data packets that meet specific specifications&rdquo;. This &ldquo;specification&rdquo; defines the structure, sequence, and direction of the handshake packets - when the specification specifies the structure and the size of each data in this structure is predictable, the size of these handshake packets has actually become predictable. Coupled with the one-to-one correspondence between the sequence and direction of the TLS specification and the reviewer&rsquo;s estimate of the handshake packet size, the traffic classification system can roughly distinguish TLS traffic.</p>
<p>For example, here is a lovely Cat protocol. Its handshake packets are sent at the beginning of the connection. Its specification stipulates the structure, sequence, and direction of sending and receiving as follows:</p>
<ul>
<li>Structure &amp; Sequence:</li>
<li>First packet: 200 bits of cat weight</li>
<li>Second packet: 700 bits of breed number</li>
<li>Third packet: 1400 bits of cat love</li>
<li>Fourth packet: 1400 bits of cat food remaining</li>
<li>Send and receive direction</li>
<li>First packet: A -&gt; B</li>
<li>Second packet: A -&gt; B</li>
<li>Third packet: A &lt;- B</li>
<li>Fourth packet: A &lt;- B</li>
</ul>
<p>At the same time, we encrypt each packet of the Cat protocol before transmission, <strong>making them 10-200 bits larger after encryption</strong>. <em>(Encryption defined by modern cryptography can only make the size of the data unchanged or increase after encryption)</em></p>
<p>So when the traffic classification system tries to detect <strong>encrypted Cat protocol</strong>, it only needs to passively observe at the beginning of each connection and judge it like this:</p>
<ul>
<li>First packet: size between 210 bits and 400 bits, direction A -&gt; B</li>
<li>Second packet: size between 710 bits and 900 bits, direction A -&gt; B</li>
<li>Third packet: size between 1410 bits and 1600 bits, direction A &lt;- B&quot;</li>
<li>Fourth packet: size between 1410 bits and 1600 bits, direction A &lt;- B</li>
</ul>
<p>If the beginning of a connection is observed to match this traffic pattern, it is likely to be the Cat protocol. Encryption defined by modern cryptography can only make the size of each handshake packet in the traffic fluctuate within a predictable range, and encryption cannot change the order and direction of sending and receiving. Therefore, this traffic pattern cannot be completely changed by encryption, and the &ldquo;TLS in Any&rdquo; vulnerability cannot be solved.</p>
<p>What if it is a misjudgment? Misjudgment is indeed possible, but in reality, when a user visits an HTTPS website, there are often several TLS connections opened. At the beginning of these connections, the TLS handshake packets are proxied by circumvention tools, so these connections are likely to be identified by the traffic classification system.
As long as the probability of misjudgment (false positive rate) is much smaller than the probability of correct identification, the censor only needs to observe whether a certain user accesses a foreign server. Whether there are more connections identified as circumvention traffic by the traffic classification system, and then judge whether the user is using circumvention tools.
Since the probability of misjudgment is much smaller than the probability of correct identification, ordinary users who do not use circumvention tools must have fewer misjudged connections, and naturally it is difficult to reach the level of &ldquo;being judged by the censor as using circumvention tools&rdquo;.</p>
<h3 id="why-does-the-tls-in-any-issue-need-to-be-taken-seriously">🤔Why does the TLS in Any issue need to be taken seriously?
</h3><ol>
<li>There have been precedents of censors in mainland China using <strong>entropy-based rules</strong> to roughly detect and block fully encrypted proxies. However, this censorship strategy still has a high false positive rate of 0.6% in the <a class="link" href="https://gfw.report/publications/usenixsecurity23/zh/#sec:blocking-analysis"  target="_blank" rel="noopener"
    >GFW.REPORT experiment (Section 7.2)</a>. Because censors face the <a class="link" href="https://zh.wikipedia.org/wiki/%e5%9f%ba%e6%9c%ac%e7%8e%87%e8%ac%ac%e8%aa%a4"  target="_blank" rel="noopener"
    >base rate fallacy problem</a>, the 0.6% false positive rate means that when this censorship strategy is widely used by GFW for all traffic, it will also cause a lot of normal traffic to be accidentally damaged.</li>
</ol>
<p>Therefore, censors need to use <strong>additional censorship strategies</strong> to control the number of accidental damages when expanding the scope of censorship. The traffic classification-based censorship strategy introduced by the &ldquo;TLS in Any&rdquo; vulnerability is an <strong>excellent additional censorship strategy</strong>. The joint use of these two censorship strategies will effectively improve the censors&rsquo; ability to detect and block circumvention traffic.</p>
<ol start="2">
<li>In the <a class="link" href="https://www.usenix.org/conference/usenixsecurity24/presentation/xue-fingerprinting"  target="_blank" rel="noopener"
    >paper</a> mentioned at the beginning of this article, the author proposed two <strong>traffic pre-classifiers</strong> for existing evasion tools in Section 8 of the paper. The classification criteria are relatively rough, but they can also be used as the <strong>&ldquo;additional censorship strategies&rdquo;</strong> mentioned in 1., and further improve the censor&rsquo;s identification ability when used together with other censorship strategies.</li>
</ol>
<ul>
<li>Pre-classifier 1 is based on &ldquo;the <strong>round-trip count</strong> within the first 15 packets of the TCP connection **after the outer TLS handshake is completed&rdquo;</li>
</ul>
<p>How to understand? In a normal TCP connection, the server will always respond with an ACK packet <em>(that is, the TCP packet with the value of the ACK flag in the TCP header which is set to the value of the SEQ sequence number of the next packet that the server should receive)</em> every time it receives a data packet from the client, so the censor can know the total <strong>number of round trips</strong> of data transmitted between the user and the server by recording the ACK packets passing through the censor in the user&rsquo;s TCP connection. I call it <strong>&ldquo;round-trip count&rdquo;</strong>. In a typical HTTPS access process to a website, after the TLS handshake is completed, the TCP connection initiated by the user usually only has one GET request <em>(one uplink)</em>, and a series of response packets <em>(one downlink)</em> from the web server, with a total of only <strong>1 round trip</strong>.</p>
<p>If the circumvention tool proxies the same HTTPS request, after the TLS handshake of the circumvention tool is completed, <strong>1 (nested) TLS handshake will be proxied first</strong>, and then the 1 round-trip HTTP request process mentioned above will be performed. And this proxied (nested) TLS handshake** will at least add 1 round-trip** to the connection initiated by the circumvention tool. Therefore, when using this preprocessor, filtering out connections with large round-trip counts will avoid processing and accidental damage to most normal traffic.</p>
<ul>
<li>Preclassifier 2 is based on &ldquo;the <strong>total size</strong> of the first packet sequence (burst) of the TCP connection **after the outer TLS handshake is completed&rdquo;</li>
</ul>
<p>How to understand? In a normal TCP connection, given the different carrying capacity of each route in the network path, a large packet needs to be divided into several parts (i.e., fragments),Then, at a certain time interval, <strong>parts are sent one by one</strong>. The process of sending parts one by one forms a series of packets, which originally belong to the same packet. A series of packets is called a packet sequence (burst). Because the evasion tool needs to proxy 1 (nested) TLS handshake** when proxying HTTPS requests, plus the size expansion caused by encryption, the <strong>total size</strong> of the first packet sequence will be larger than the first packet sequence of normal HTTPS traffic.</p>
<p>Although the classification criteria of these two traffic pre-classifiers are rough, their performance in the [paper] (<a class="link" href="https://www.usenix.org/conference/usenixsecurity24/presentation/xue-fingerprinting"  target="_blank" rel="noopener"
    >https://www.usenix.org/conference/usenixsecurity24/presentation/xue-fingerprinting</a>) mentioned at the beginning is not bad. According to the experimental data in Section 8 of the paper, when the screening criteria are set to less than 2.5 round-trip counts for pre-classifier 1 and less than 300 bytes for pre-classifier 2, the two pre-classifiers work in series and can filter out 82.5% of normal traffic and 1.5% of proxy traffic.</p>
<h3 id="inspiration-from-the-censorship-strategy-based-on-traffic-classification">💡Inspiration from the censorship strategy based on traffic classification
</h3><p>After discussing the traffic classification identification principle of the TLS in Any problem, I also made two summaries, hoping to help readers understand the essence of the problem more deeply.</p>
<ol>
<li>
<p><strong>Packet-level</strong> obfuscation strategies (filling, encryption, reordering, etc. of data in a single packet) are not enough to counter <strong>connection-level</strong> censorship strategies, which can be explained in popular terms as &ldquo;dimensionality reduction strikes&rdquo;.</p>
</li>
<li>
<p>Connection-level features (size distribution within the distance of the first n packets of each connection, round-trip counts, and even packet sending and receiving delay distribution, etc.) should also be processed by filling packets, splitting packets, delaying packets, etc.</p>
</li>
</ol>
<h3 id="conceived-avoidance-strategies-for-the-tls-in-any-problem">🧰Conceived avoidance strategies for the TLS in Any problem
</h3><p>At the same time, I also envisioned the following feasible solutions (avoidance strategies), hoping to inspire readers to find more feasible avoidance strategies. The essence of the following avoidance strategies is to maximize the misjudgment rate of the traffic classification system.</p>
<ol>
<li>
<p>Deconstruct the upstream and downstream connections <em>(the disadvantage is poor reliability)</em></p>
</li>
<li>
<p>Send the proxied TLS handshake packets in fragments, and make a false response to each received fragment before the receiver receives the last fragment of a handshake packet <em>(such as constructing a packet with checksum errors for response)</em>, to prevent the censor from merging fragments (reassembling traffic) or creating more obvious features.</p>
</li>
</ol>
<p>(This strategy has been implemented in the circumvention tool Restls Protocol <a class="link" href="https://github.com/3andne/restls"  target="_blank" rel="noopener"
    >(Github repository link)</a>, but this strategy is likely to have a significant impact on user experience)</p>
<ol start="3">
<li>Switch to QUIC-based circumvention tools, using the unreliability of udp to increase the complexity of traffic classification, thereby causing censors to at least slow down the development and deployment of their censorship technology.</li>
</ol>
<p>(Unfortunately, during the [Third Plenary Session of the 20th Central Committee of the Communist Party of China](<a class="link" href="https://zh.wikipedia.org/wiki/The"  target="_blank" rel="noopener"
    >https://zh.wikipedia.org/wiki/The</a> Third Plenary Session of the 20th Central Committee of the Communist Party of China) held on July 15-18, 2024, there were spontaneous reports of users in mainland China blocking UDP-based circumvention tools on a large scale (<a class="link" href="https://linux.do/t/topic/136940/3"  target="_blank" rel="noopener"
    >link</a> from the LinuxDo forum))</p>
<h3 id="several-challenges-for-censors-to-deploy-traffic-classification-based-censorship-strategies-at-scale">🧱Several challenges for censors to deploy traffic classification-based censorship strategies at scale
</h3><ol>
<li>Collateral damage is still quite high. Especially now that TLS1.3 is being deployed on a larger scale, while TLS1.2 deployment is decreasing, according to the experimental data of the traffic classification system deployed on the network egress of the US operator <a class="link" href="https://www.merit.edu/"  target="_blank" rel="noopener"
    >Merit Network</a> in the <a class="link" href="https://www.usenix.org/conference/usenixsecurity24/presentation/xue-fingerprinting"  target="_blank" rel="noopener"
    >paper</a> mentioned at the beginning of this article, when the TLS1.3 classifier runs in a mode with a true positive rate of about 26% in the experiment, its misjudgment rate (false positive rate) increases by 40 times (0.025%→1%) compared to the TLS1.2 classifier with a slightly lower true positive rate (about 24%).</li>
<li>For evasion tools that use <strong>aggressive random padding strategies</strong> (such as XTLS-Vision, obfs4), the reviewer needs to use additional custom classifiers to process the traffic; and since the packet size is no longer suitable for classification, the misjudgment rate (false positive rate) should increase.</li>
<li>For evasion tools that are based on TLS and use aggressive random padding strategies, since only the handshake packet in normal TLS traffic has low entropy, it is theoretically impossible to use entropy-based rules to pre-classify the proxy traffic of these evasion tools. This situation should further increase the misjudgment rate (false positive rate).</li>
</ol>
<p><em>(Recommended related reading: )</em></p>
<p>1.<a class="link" href="https://github.com/XTLS/Xray-core/discussions/1295"  target="_blank" rel="noopener"
    >XTLS Vision, fixes TLS in TLS, to the star and beyond · XTLS/Xray-core · Discussion #1295 (github.com)</a> (&ldquo;Five Packets of Life and Death&rdquo; original source)</p>

</section>


    <footer class="article-footer">
    
    <section class="article-tags">
        
            <a href="/en/tags/anti-censorship/">Anti-Censorship</a>
        
            <a href="/en/tags/traffic-classification/">Traffic Classification</a>
        
            <a href="/en/tags/tls/">TLS</a>
        
            <a href="/en/tags/encrypted-proxy/">Encrypted Proxy</a>
        
    </section>


    
    <section class="article-copyright">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <path d="M14.5 9a3.5 4 0 1 0 0 6" />
</svg>



        <span>Licensed under <a class="link" href="https://creativecommons.org/licenses/by-nc-sa/4.0/"  target="_blank" rel="noopener"
    >CC BY-NC-SA 4.0</a></span>
    </section>
    </footer>


    
</article>

    

    

     
    
        
    <script
    src="https://giscus.app/client.js"
    data-repo="ShadowObj/blog"
    data-repo-id="R_kgDOMcbEhw"
    data-category="Announcements"
    data-category-id="DIC_kwDOMcbEh84ChRoq"
    data-mapping="pathname"
    data-strict="0"
    data-reactions-enabled="1"
    data-emit-metadata="0"
    data-input-position="top"
    data-theme="light"
    data-lang="en"
    crossorigin="anonymous"
    async
></script>
<script>
    function setGiscusTheme(theme) {
        let giscus = document.querySelector("iframe.giscus-frame");
        if (giscus) {
            giscus.contentWindow.postMessage(
                {
                    giscus: {
                        setConfig: {
                            theme: theme,
                        },
                    },
                },
                "https://giscus.app"
            );
        }
    }

    (function () {
        addEventListener("message", (e) => {
            if (event.origin !== "https://giscus.app") return;
            handler();
        });
        window.addEventListener("onColorSchemeChange", handler);

        function handler() {
            if (document.documentElement.dataset.scheme === "light") {
                setGiscusTheme('light');
            } else {
                setGiscusTheme('dark_dimmed');
            }
        }
    })();
</script>

    

    <footer class="site-footer">
    <section class="copyright">
        &copy; 
        
        2024 ObjShadow&#39;s Blog
    </section>
    
    <section class="powerby">
        
            与自由拥抱。Embrace Liberty.<br>
Supports 
<a href="https://ready.chair6.net/?url=https%3A%2F%2Fobjshadow.pages.dev" target="_blank" rel="noopener">
    <b>IPv6</b>
</a>, 
<a href="https://http3check.net/?host=objshadow.pages.dev" target="_blank" rel="noopener">
    <b>HTTP/3</b>
</a>, 
<a href="https://datatracker.ietf.org/doc/html/rfc8446" target="_blank" rel="noopener">
    <b>TLS 1.3</b>
</a> with 
<a href="https://hstspreload.org/?domain=objshadow.pages.dev" target="_blank" rel="noopener">
    <b>HSTS Preload</b>
</a> &amp; 
<a href="https://www.cloudflare.com/dns/dnssec/how-dnssec-works/" target="_blank" rel="noopener">
    <b>DNSSEC</b>
</a>
 <br/>
        Built with <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> <br />
        Theme <b><a href="https://github.com/CaiJimmy/hugo-theme-stack" target="_blank" rel="noopener" data-version="3.26.0">Stack</a></b> designed by <a href="https://jimmycai.com" target="_blank" rel="noopener">Jimmy</a>
    </section>
</footer>


    
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    
    <div class="pswp__bg"></div>

    
    <div class="pswp__scroll-wrap">

        
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                
                
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo="crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU="crossorigin="anonymous"
                defer
                >
            </script><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css"crossorigin="anonymous"
            ><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css"crossorigin="anonymous"
            >

            </main>
        </div>
        <script 
                src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js"integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z&#43;KMkF24hUW8WePSA9HM="crossorigin="anonymous"
                
                >
            </script><script type="text/javascript" src="/ts/main.js" defer></script>
<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>

<script>
function getWindowScrollTop() {
    var scroll_top = 0;
    if (document.documentElement && document.documentElement.scrollTop) {
      scroll_top = document.documentElement.scrollTop;
    } else if (document.body) {
      scroll_top = document.body.scrollTop;
    }
    return scroll_top;
}

function scrollToViewCenter(element) {
    let { top, height } = element.getBoundingClientRect();
    let elementCenter = top + height / 2;
    let center = window.innerHeight / 2;
    window.scrollTo({
      top: getWindowScrollTop() - (center - elementCenter),
      behavior: 'smooth'
    });
}

function highlight(element, color = "#8CC7B5") {
    element.style.color = color;
    element.style.fontWeight = "bold";
}

function unhighlight(element, color = "#8CC7B5") {
    element.style.removeProperty("color");
    element.style.fontWeight = "normal";
}

const params = new URLSearchParams(window.location.search);
const highlightElements = document.getElementsByClassName(params.get("highlight"));
if (highlightElements != null) {
    for (let element of highlightElements) {
        highlight(element);
    }
    scrollToViewCenter(highlightElements.item(0));
    document.body.addEventListener("click", function() {
        for (let element of highlightElements) {
            unhighlight(element);
        }
    })
}
</script>

<script>
window.onscroll = function () {
    let currentHeight = document.documentElement.scrollTop || document.body.scrollTop;
    let visibleHeight = innerHeight||document.documentElement.clientHeight||document.body.clientHeight
    if (currentHeight > (visibleHeight)) {
        document.getElementById('scrollTop').style.display = 'block'
    } else {
        document.getElementById('scrollTop').style.display = 'none'
    }
}

function smoothScrollTop(){
    let timer  = null;
    cancelAnimationFrame(timer);
    timer = requestAnimationFrame(function fn(){
        let currentHeight = document.body.scrollTop || document.documentElement.scrollTop;
        if(currentHeight > 0){
            document.body.scrollTop = document.documentElement.scrollTop = currentHeight - 50;
            timer = requestAnimationFrame(fn);
        } else {
            cancelAnimationFrame(timer);
        }
    });
}
</script>
        <button onclick="smoothScrollTop()" id="scrollTop">
            <svg  xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-arrow-up"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M12 5l0 14" /><path d="M18 11l-6 -6" /><path d="M6 11l6 -6" /></svg>
        </button>
    </body>
</html>
