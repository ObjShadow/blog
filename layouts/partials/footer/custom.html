<div id="popup-container"></div>
<script>
'use strict'
// Text Highlight
function getWindowScrollTop() {
    var scroll_top = 0;
    if (document.documentElement && document.documentElement.scrollTop) {
      scroll_top = document.documentElement.scrollTop;
    } else if (document.body) {
      scroll_top = document.body.scrollTop;
    }
    return scroll_top;
}

/**
 * Scroll specific HTMLElement to the center
 * @param {HTMLElement} element
 */
function scrollToViewCenter(element) {
    var { top, height } = element.getBoundingClientRect();
    let elementCenter = top + height / 2;
    let center = window.innerHeight / 2;
    window.scrollTo({
      top: getWindowScrollTop() - (center - elementCenter),
      behavior: 'smooth'
    });
}

function highlight(element, color = "#8CC7B5") {
    element.style.color = color;
    element.style.fontWeight = "bold";
}

function unhighlight(element, color = "#8CC7B5") {
    element.style.removeProperty("color");
    element.style.fontWeight = "normal";
}

const params = new URLSearchParams(window.location.search);
const highlightElements = document.getElementsByClassName(params.get("highlight"));
if (highlightElements.length > 0) {
    for (let element of highlightElements) {
        highlight(element);
        element.addEventListener("click", function() {
            for (let element of highlightElements) { unhighlight(element); }
        });
    }
    scrollToViewCenter(highlightElements.item(0));
    let newUrl = window.location.href.replace(new RegExp("\\??&?highlight=?1".replace("?1", params.get("highlight"))),"");
    window.history.replaceState('', '', newUrl);
}

// popup
const popupContainer = document.getElementById('popup-container');
function showPopup(content) {
    const popup = document.createElement('div');
    const closeBtn = document.createElement('button');
    const barContainer = document.createElement('div');
    const progressBar = document.createElement('div');
    barContainer.classList.add('bar-container');
    progressBar.classList.add('progress-bar');
    barContainer.appendChild(progressBar);
    closeBtn.innerHTML = '{{ $icon := resources.Get "icons/cross.svg" }}{{ $icon.Content | safeHTML }}';
    closeBtn.classList.add('closeBtn');
    closeBtn.type = "button";
    closeBtn.title = "close";
    closeBtn.addEventListener("click", () => {
        popup.classList.add('slide-out');
        popup.addEventListener('animationend', () => { popup.remove(); });
    });
    popup.classList.add('popup');
    popup.appendChild(barContainer);
    popup.appendChild(closeBtn);
    popup.appendChild(content);
    popupContainer.prepend(popup);

    popup.classList.add('slide-in');
    popup.addEventListener('animationend', () => {
        progressBar.style = "transition: transform 2.95s linear; transform: scaleX(1);";
        popup.classList.add('bounce');
    });
    popup.addEventListener('animationend', () => {
        setTimeout(() => {
            popup.classList.add('slide-out');
            popup.addEventListener('animationend', () => { popup.remove(); });
        }, 3000); 
    });
}

{{ $origin := "objshadow.pages.dev" }}
function isMirror(origin) {
    if (window.location.hostname != origin) {
        const content = document.createElement('div');
        content.innerHTML = `
        <h3 class="title">
            {{ $icon := resources.Get "icons/bell.svg" }}
            {{ $icon.Content | safeHTML }}正在访问镜像
        </h3><p>本镜像站由博主架设, 以便中国大陆用户访问. 
            主站: <a class="link" href="{{ printf "https://%s/" $origin }}">objshadow.pages.dev</a>
        </p>`
        showPopup(content)
    }
}

addEventListener('DOMContentLoaded', () => { isMirror({{ $origin }}); });
</script>
